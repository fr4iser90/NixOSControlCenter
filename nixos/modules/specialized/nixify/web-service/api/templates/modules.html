{{define "modules"}}
<div class="container">
    <header>
        <h1>{{.T "modules.title"}}</h1>
        <p class="subtitle">{{.T "modules.subtitle"}}</p>
    </header>

    <div class="section">
        <div class="filter-row">
            <input type="text" id="searchInput" placeholder="{{.T "modules.search"}}" class="search-input">
            <select id="typeFilter" class="filter-select">
                <option value="">{{.T "modules.filter.all_types"}}</option>
                <option value="core">{{.T "modules.filter.core"}}</option>
                <option value="optional">{{.T "modules.filter.optional"}}</option>
            </select>
            <select id="categoryFilter" class="filter-select">
                <option value="">{{.T "modules.filter.all_categories"}}</option>
                <option value="base">{{.T "modules.filter.base"}}</option>
                <option value="management">{{.T "modules.filter.management"}}</option>
                <option value="infrastructure">{{.T "modules.filter.infrastructure"}}</option>
                <option value="security">{{.T "modules.filter.security"}}</option>
                <option value="specialized">{{.T "modules.filter.specialized"}}</option>
                <option value="system">{{.T "modules.filter.system"}}</option>
            </select>
            {{if .ShowStatusBadge}}
            <select id="statusFilter" class="filter-select">
                <option value="">{{.T "modules.filter.all_status"}}</option>
                <option value="active">{{.T "modules.filter.active"}}</option>
                <option value="disabled">{{.T "modules.filter.disabled"}}</option>
                <option value="planned">{{.T "modules.filter.planned"}}</option>
            </select>
            {{end}}
        </div>
        
        <!-- Stats Bar -->
        <div class="modules-stats">
            <span class="stat-item">
                <strong id="totalCount">0</strong> {{.T "modules.stats.total"}}
            </span>
            <span class="stat-item">
                <strong id="coreCount">0</strong> {{.T "modules.stats.core"}}
            </span>
            <span class="stat-item">
                <strong id="optionalCount">0</strong> {{.T "modules.stats.optional"}}
            </span>
        </div>
        
        <!-- Grouped Modules Display -->
        <div id="modulesContainer">
            <!-- Core Modules Section -->
            <div class="module-section" id="coreSection" data-type="core">
                <div class="section-header" onclick="toggleSection('core')">
                    <h2 class="section-title">
                        <span class="section-icon">‚öôÔ∏è</span>
                        {{.T "modules.sections.core"}}
                        <span class="section-count" id="coreSectionCount">0</span>
                    </h2>
                    <button class="collapse-toggle" data-section="core" aria-label="Toggle section">‚àí</button>
                </div>
                <div class="section-content" id="coreContent">
                    <div class="modules-grid" id="coreGrid"></div>
                </div>
            </div>
            
            <!-- Optional Modules Section -->
            <div class="module-section" id="optionalSection" data-type="optional">
                <div class="section-header" onclick="toggleSection('optional')">
                    <h2 class="section-title">
                        <span class="section-icon">üß©</span>
                        {{.T "modules.sections.optional"}}
                        <span class="section-count" id="optionalSectionCount">0</span>
                    </h2>
                    <button class="collapse-toggle" data-section="optional" aria-label="Toggle section">‚àí</button>
                </div>
                <div class="section-content" id="optionalContent">
                    <div class="modules-grid" id="optionalGrid"></div>
                </div>
            </div>
        </div>
        
        <div id="noResults" class="no-results">
            {{.T "modules.no_results"}}
        </div>
    </div>
</div>

<script nonce="{{.Nonce}}">
    const modules = {{.ModulesJSON}};
    const translations = {
        no_results: "{{.T "modules.no_results"}}",
        view_details: "{{.T "modules.view_details"}}",
        version: "{{.T "modules.version"}}",
        features: {
            tui: "{{.T "modules.features.tui"}}",
            scripts: "{{.T "modules.features.scripts"}}",
            handlers: "{{.T "modules.features.handlers"}}",
            lib: "{{.T "modules.features.lib"}}"
        }
    };
    
    // Extract subcategory from full category string (e.g., "core.base.audio" -> "base")
    function getSubCategory(category) {
        const parts = category.split('.');
        if (parts.length > 1) {
            return parts[1]; // base, management, infrastructure, etc.
        }
        return category;
    }
    
    // Check if module is core or optional
    function isCoreModule(category) {
        return category.startsWith('core.');
    }
    
    function renderModules(filteredModules) {
        const coreModules = filteredModules.filter(m => isCoreModule(m.category));
        const optionalModules = filteredModules.filter(m => !isCoreModule(m.category));
        
        // Update stats
        document.getElementById('totalCount').textContent = filteredModules.length;
        document.getElementById('coreCount').textContent = coreModules.length;
        document.getElementById('optionalCount').textContent = optionalModules.length;
        document.getElementById('coreSectionCount').textContent = coreModules.length;
        document.getElementById('optionalSectionCount').textContent = optionalModules.length;
        
        // Render core modules
        renderModuleGrid('coreGrid', coreModules);
        
        // Render optional modules
        renderModuleGrid('optionalGrid', optionalModules);
        
        // Show/hide sections
        document.getElementById('coreSection').style.display = coreModules.length > 0 ? 'block' : 'none';
        document.getElementById('optionalSection').style.display = optionalModules.length > 0 ? 'block' : 'none';
        
        // Show no results
        const noResults = document.getElementById('noResults');
        if (filteredModules.length === 0) {
            noResults.style.display = 'block';
        } else {
            noResults.style.display = 'none';
        }
    }
    
    function renderModuleGrid(containerId, modules) {
        const container = document.getElementById(containerId);
        
        if (modules.length === 0) {
            container.innerHTML = '<p class="no-modules-message">' + translations.no_results + '</p>';
            return;
        }
        
        container.innerHTML = modules.map(module => {
            const features = [];
            if (module.has_tui) features.push(translations.features.tui);
            if (module.has_scripts) features.push(translations.features.scripts);
            if (module.has_handlers) features.push(translations.features.handlers);
            if (module.has_lib) features.push(translations.features.lib);
            
            let statusClass, statusText;
            if (module.status === 'active') {
                statusClass = 'status-active';
                statusText = '‚úÖ Active';
            } else if (module.status === 'disabled') {
                statusClass = 'status-disabled';
                statusText = '‚ùå Disabled';
            } else {
                statusClass = 'status-planned';
                statusText = 'üìã Planned';
            }
            
            const subCategory = getSubCategory(module.category);
            const moduleType = isCoreModule(module.category) ? 'core' : 'optional';
            
            return `
                <div class="module-card" data-type="${moduleType}" onclick="window.location.href='/module/${escapeHtml(module.name)}'">
                    <div class="module-header">
                        <div>
                            <h3 class="module-name">üß© ${escapeHtml(module.name)}</h3>
                            <div class="module-category">${escapeHtml(module.category)}</div>
                            <span class="category-badge category-${subCategory}">${escapeHtml(subCategory)}</span>
                        </div>
                        ${module.show_status_badge ? `<span class="status-badge ${statusClass}">${statusText}</span>` : ''}
                    </div>
                    <p class="module-description">${escapeHtml(module.description)}</p>
                    ${features.length > 0 ? `
                        <div class="module-features">
                            ${features.map(f => `<span class="feature-badge">${f}</span>`).join('')}
                        </div>
                    ` : ''}
                    <div class="module-footer">
                        <span class="module-version">${translations.version}: ${escapeHtml(module.version)}</span>
                        <a href="/module/${escapeHtml(module.name)}" class="module-link" onclick="event.stopPropagation();">${translations.view_details} ‚Üí</a>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function filterModules() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const typeFilter = document.getElementById('typeFilter').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        const statusFilter = document.getElementById('statusFilter');
        const status = statusFilter ? statusFilter.value : '';
        
        const filtered = modules.filter(module => {
            const matchesSearch = !query || 
                module.name.toLowerCase().includes(query) ||
                module.description.toLowerCase().includes(query) ||
                module.category.toLowerCase().includes(query);
            
            const matchesType = !typeFilter || 
                (typeFilter === 'core' && isCoreModule(module.category)) ||
                (typeFilter === 'optional' && !isCoreModule(module.category));
            
            const subCategory = getSubCategory(module.category);
            const matchesCategory = !categoryFilter || subCategory === categoryFilter;
            
            const matchesStatus = !status || module.status === status;
            
            return matchesSearch && matchesType && matchesCategory && matchesStatus;
        });
        
        renderModules(filtered);
    }
    
    function toggleSection(sectionName) {
        const content = document.getElementById(sectionName + 'Content');
        const toggle = document.querySelector(`[data-section="${sectionName}"]`);
        const isCollapsed = content.classList.contains('collapsed');
        
        if (isCollapsed) {
            content.classList.remove('collapsed');
            toggle.textContent = '‚àí';
        } else {
            content.classList.add('collapsed');
            toggle.textContent = '+';
        }
    }
    
    // Event listeners
    document.getElementById('searchInput').addEventListener('input', filterModules);
    document.getElementById('typeFilter').addEventListener('change', filterModules);
    document.getElementById('categoryFilter').addEventListener('change', filterModules);
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', filterModules);
    }
    
    // Collapse/expand sections
    document.querySelectorAll('.collapse-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.stopPropagation();
            const section = this.dataset.section;
            toggleSection(section);
        });
    });
    
    // Initial render
    renderModules(modules);
</script>
{{end}}
