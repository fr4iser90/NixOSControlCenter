{{define "index"}}
    <div class="container">
        <header>
            <h1>{{.T "header.title"}}</h1>
            <p class="subtitle">{{.T "header.subtitle"}}</p>
        </header>
        
        <div class="section">
            <h2>{{.T "sections.what_is_nixos"}}</h2>
            <div class="info-box success">
                <h3>{{.T "nixos.declarative.title"}}</h3>
                <p>{{.T "nixos.declarative.text"}}</p>
            </div>
            
            <div class="info-box success">
                <h3>{{.T "nixos.immutable.title"}}</h3>
                <p>{{.T "nixos.immutable.text"}}</p>
            </div>
            
            <div class="info-box success">
                <h3>{{.T "nixos.atomic.title"}}</h3>
                <p>{{.T "nixos.atomic.text"}}</p>
            </div>
        </div>
        
        <div class="section">
            <h2>{{.T "sections.what_does_nixify"}}</h2>
            <p>{{.T "nixify.description"}}</p>
            <ul>
                <li><strong>{{.T "nixify.features.programs"}}</strong></li>
                <li><strong>{{.T "nixify.features.settings"}}</strong></li>
                <li><strong>{{.T "nixify.features.hardware"}}</strong></li>
                <li><strong>{{.T "nixify.features.config"}}</strong></li>
                <li><strong>{{.T "nixify.features.iso"}}</strong></li>
            </ul>
        </div>
        
        <div class="section">
            <h2>{{.T "sections.how_it_works"}}</h2>
            <div class="workflow">
                <div class="workflow-step">
                    <div class="workflow-step-number">{{.T "workflow.step1.number"}}</div>
                    <h3>{{.T "workflow.step1.title"}}</h3>
                    <p>{{.T "workflow.step1.text"}}</p>
                </div>
                <div class="workflow-step">
                    <div class="workflow-step-number">{{.T "workflow.step2.number"}}</div>
                    <h3>{{.T "workflow.step2.title"}}</h3>
                    <p>{{.T "workflow.step2.text"}}</p>
                </div>
                <div class="workflow-step">
                    <div class="workflow-step-number">{{.T "workflow.step3.number"}}</div>
                    <h3>{{.T "workflow.step3.title"}}</h3>
                    <p>{{.T "workflow.step3.text"}}</p>
                </div>
                <div class="workflow-step">
                    <div class="workflow-step-number">{{.T "workflow.step4.number"}}</div>
                    <h3>{{.T "workflow.step4.title"}}</h3>
                    <p>{{.T "workflow.step4.text"}}</p>
                </div>
                <div class="workflow-step">
                    <div class="workflow-step-number">{{.T "workflow.step5.number"}}</div>
                    <h3>{{.T "workflow.step5.title"}}</h3>
                    <p>{{.T "workflow.step5.text"}}</p>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>{{.T "sections.download_scripts"}}</h2>
            <p>{{.T "download.instructions"}}</p>
            <div class="download-grid">
                <div class="download-card">
                    <h3>{{.T "download.windows.title"}}</h3>
                    <p>{{.T "download.windows.description"}}</p>
                    <a href="/download/windows" class="btn">{{.T "download.button"}}</a>
                    <p class="download-card-meta">
                        <code>{{.T "download.windows.filename"}}</code>
                    </p>
                </div>
                <div class="download-card">
                    <h3>{{.T "download.macos.title"}}</h3>
                    <p>{{.T "download.macos.description"}}</p>
                    <a href="/download/macos" class="btn">{{.T "download.button"}}</a>
                    <p class="download-card-meta">
                        <code>{{.T "download.macos.filename"}}</code>
                    </p>
                </div>
                <div class="download-card">
                    <h3>{{.T "download.linux.title"}}</h3>
                    <p>{{.T "download.linux.description"}}</p>
                    <a href="/download/linux" class="btn">{{.T "download.button"}}</a>
                    <p class="download-card-meta">
                        <code>{{.T "download.linux.filename"}}</code>
                    </p>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>{{.T "sections.upload_report"}}</h2>
            <p>{{.T "upload.description"}}</p>
            
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept=".json,application/json">
                    <p class="upload-text">{{.T "upload.drop_zone"}}</p>
                    <p class="upload-subtext">{{.T "upload.supported"}}</p>
                </div>
                <div id="uploadError" class="error-message hidden"></div>
            </div>
            
            <div id="sessionStatus" class="hidden">
                <div class="session-card">
                    <h3>{{.T "session.status_title"}}</h3>
                    <p><strong>{{.T "session.id"}}:</strong> <code id="sessionId"></code></p>
                    <p><strong>{{.T "session.status"}}:</strong> <span class="session-status" id="sessionStatusBadge">queued</span></p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
                    </div>
                    <div id="sessionActions" class="hidden session-actions">
                        <button class="btn" onclick="downloadConfig()">{{.T "session.download_config"}}</button>
                        <button class="btn btn-secondary" onclick="buildISO()">{{.T "session.build_iso"}}</button>
                        <button class="btn btn-danger hidden" onclick="downloadISO()" id="downloadISOBtn">{{.T "session.download_iso"}}</button>
                    </div>
                    <div id="sessionError" class="error-message hidden"></div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>{{.T "sections.important_notes"}}</h2>
            
            <div class="info-box warning">
                <h3>{{.T "warnings.kernel_anticheat.title"}}</h3>
                <p><strong>{{.T "warnings.kernel_anticheat.text"}}</strong></p>
                <p>{{.T "warnings.kernel_anticheat.details"}}</p>
            </div>
            
            <div class="info-box info">
                <h3>{{.T "warnings.wine_proton.title"}}</h3>
                <p>{{.T "warnings.wine_proton.text"}}</p>
                <ul>
                    {{range .TArray "warnings.wine_proton.features"}}
                    <li>{{.}}</li>
                    {{end}}
                </ul>
            </div>
            
            <div class="info-box success">
                <h3>{{.T "warnings.what_works.title"}}</h3>
                <ul>
                    {{range .TArray "warnings.what_works.items"}}
                    <li>{{.}}</li>
                    {{end}}
                </ul>
            </div>
            
            <div class="info-box info">
                <h3>{{.T "warnings.about_config.title"}}</h3>
                <p>{{.T "warnings.about_config.text"}}</p>
                <ul>
                    {{range .TArray "warnings.about_config.features"}}
                    <li>{{.}}</li>
                    {{end}}
                </ul>
            </div>
        </div>
        
        <div class="section">
            <h2>{{.T "sections.service_status"}}</h2>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value">{{.Sessions}}</div>
                    <div class="stat-label">{{.T "status.active_sessions"}}</div>
                </div>
                <div class="stat">
                    <div class="stat-value stat-value-small">{{.Host}}:{{.Port}}</div>
                    <div class="stat-label">{{.T "status.service_address"}}</div>
                </div>
                <div class="stat">
                    <div class="stat-value">{{.T "status.online"}}</div>
                    <div class="stat-label">{{.T "status.service_status"}}</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>{{.T "api.title"}}</h2>
            <p>{{.T "api.description"}}</p>
            
            <div class="endpoint">
                <span class="method">GET</span> <span class="path">/api/v1/health</span>
                <p>{{.T "api.endpoints.health"}}</p>
            </div>
            
            <div class="endpoint">
                <span class="method">POST</span> <span class="path">/api/v1/upload</span>
                <p>{{.T "api.endpoints.upload"}}</p>
            </div>
            
            <div class="endpoint">
                <span class="method">GET</span> <span class="path">/api/v1/sessions</span>
                <p>{{.T "api.endpoints.sessions"}}</p>
            </div>
            
            <div class="endpoint">
                <span class="method">GET</span> <span class="path">/api/v1/session/{id}</span>
                <p>{{.T "api.endpoints.session"}}</p>
            </div>
            
            <div class="endpoint">
                <span class="method">GET</span> <span class="path">/api/v1/config/{id}</span>
                <p>{{.T "api.endpoints.config"}}</p>
            </div>
            
            <div class="endpoint">
                <span class="method">POST</span> <span class="path">/api/v1/iso/build</span>
                <p>{{.T "api.endpoints.iso_build"}}</p>
            </div>
            
            <div class="endpoint">
                <span class="method">GET</span> <span class="path">/api/v1/iso/{id}/download</span>
                <p>{{.T "api.endpoints.iso_download"}}</p>
            </div>
        </div>
        
        <div class="section section-footer">
            <p>{{.T "footer.project"}} <a href="https://github.com/fr4iser90/NixOSControlCenter">NixOS Control Center</a></p>
            <p>{{.T "footer.tagline"}}</p>
        </div>
    </div>
    
    <script nonce="{{.Nonce}}">
        let currentSessionId = null;
        let statusCheckInterval = null;
        
        // Upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadError = document.getElementById('uploadError');
        const sessionStatus = document.getElementById('sessionStatus');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        function handleFile(file) {
            if (!file.name.endsWith('.json')) {
                showError('Nur JSON-Dateien werden unterst√ºtzt!');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showError('Datei zu gro√ü! Maximum: 10MB');
                return;
            }
            
            uploadError.classList.add('hidden');
            uploadArea.innerHTML = '<p>üì§ Lade hoch...</p>';
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    uploadReport(json);
                } catch (err) {
                    showError('Ung√ºltige JSON-Datei: ' + err.message);
                    resetUploadArea();
                }
            };
            reader.readAsText(file);
        }
        
        function uploadReport(report) {
            fetch('/api/v1/upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(report)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Upload fehlgeschlagen');
                    });
                }
                return response.json();
            })
            .then(data => {
                currentSessionId = data.session_id;
                // Redirect to review page after upload
                if (data.review_url) {
                    window.location.href = data.review_url;
                } else {
                    // Fallback: redirect to review page manually
                    window.location.href = `/review/${data.session_id}`;
                }
            })
            .catch(error => {
                showError('Upload fehlgeschlagen: ' + error.message);
                resetUploadArea();
            });
        }
        
        function resetUploadArea() {
            uploadArea.innerHTML = `
                <input type="file" id="fileInput" accept=".json,application/json">
                <p class="upload-text">üìÅ Datei hier ablegen oder klicken zum Ausw√§hlen</p>
                <p class="upload-subtext">Unterst√ºtzt: JSON-Dateien (max. 10MB)</p>
            `;
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }
        
        function showError(message) {
            uploadError.textContent = message;
            uploadError.classList.remove('hidden');
        }
        
        function startStatusPolling() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            statusCheckInterval = setInterval(updateSessionStatus, 3000); // Check every 3 seconds
        }
        
        function updateSessionStatus() {
            if (!currentSessionId) return;
            
            fetch(`/api/v1/session/${currentSessionId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Session nicht gefunden');
                    return response.json();
                })
                .then(session => {
                    const statusBadge = document.getElementById('sessionStatusBadge');
                    const progressBar = document.getElementById('progressBar');
                    const sessionActions = document.getElementById('sessionActions');
                    const sessionError = document.getElementById('sessionError');
                    const downloadISOBtn = document.getElementById('downloadISOBtn');
                    
                    statusBadge.textContent = session.status;
                    statusBadge.className = 'session-status status-' + session.status;
                    
                    // Update progress
                    let progress = 0;
                    if (session.status === 'queued') progress = 10;
                    else if (session.status === 'processing') progress = 50;
                    else if (session.status === 'ready') progress = 100;
                    else if (session.status === 'building_iso') progress = 75;
                    else if (session.status === 'iso_ready') progress = 100;
                    else if (session.status === 'error') progress = 0;
                    
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                    
                    // Show actions when ready
                    if (session.status === 'ready' || session.status === 'iso_ready') {
                        sessionActions.classList.remove('hidden');
                        if (session.status === 'iso_ready') {
                            downloadISOBtn.classList.remove('hidden');
                        } else {
                            downloadISOBtn.classList.add('hidden');
                        }
                    } else {
                        sessionActions.classList.add('hidden');
                    }
                    
                    // Show error if any
                    if (session.status === 'error' && session.error) {
                        sessionError.textContent = 'Fehler: ' + session.error;
                        sessionError.classList.remove('hidden');
                    } else {
                        sessionError.classList.add('hidden');
                    }
                    
                    // Stop polling if done or error
                    if (session.status === 'ready' || session.status === 'iso_ready' || session.status === 'error') {
                        clearInterval(statusCheckInterval);
                    }
                })
                .catch(error => {
                    console.error('Status check failed:', error);
                });
        }
        
        function downloadConfig() {
            if (!currentSessionId) return;
            window.location.href = `/api/v1/config/${currentSessionId}`;
        }
        
        function buildISO() {
            if (!currentSessionId) return;
            
            fetch('/api/v1/iso/build', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: currentSessionId
                    // variant wird aus dem generierten desktop-config.nix gelesen, nicht als Parameter!
                })
            })
            .then(response => {
                if (!response.ok) throw new Error('ISO-Build fehlgeschlagen');
                return response.json();
            })
            .then(data => {
                startStatusPolling(); // Resume polling for ISO build status
            })
            .catch(error => {
                alert('Fehler beim ISO-Build: ' + error.message);
            });
        }
        
        function downloadISO() {
            if (!currentSessionId) return;
            window.location.href = `/api/v1/iso/${currentSessionId}/download`;
        }
    </script>
{{end}}
