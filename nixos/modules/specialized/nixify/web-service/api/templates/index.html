{{define "index"}}
{{block "styles" .}}
<style nonce="{{.Nonce}}">
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; padding: 40px 20px; }
        h1 { color: #4ec9b0; font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { color: #858585; font-size: 1.2em; margin-bottom: 30px; }
        
        .section { 
            background: #252526; 
            border-radius: 8px; 
            padding: 30px; 
            margin: 20px 0;
            border-left: 4px solid #4ec9b0;
        }
        h2 { color: #569cd6; margin-bottom: 20px; font-size: 1.8em; }
        h3 { color: #4ec9b0; margin: 20px 0 10px 0; }
        
        .info-box {
            background: #1e1e1e;
            border: 1px solid #3e3e3e;
            border-radius: 6px;
            padding: 20px;
            margin: 15px 0;
        }
        .warning { border-left: 4px solid #f48771; background: #2a1f1f; }
        .success { border-left: 4px solid #4ec9b0; background: #1f2a2a; }
        .info { border-left: 4px solid #569cd6; background: #1f1f2a; }
        
        .download-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .download-card {
            background: #1e1e1e;
            border: 1px solid #3e3e3e;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s, border-color 0.2s;
        }
        .download-card:hover {
            transform: translateY(-2px);
            border-color: #4ec9b0;
        }
        .download-card h3 { margin-top: 0; }
        .btn {
            display: inline-block;
            background: #4ec9b0;
            color: #1e1e1e;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            margin-top: 10px;
            transition: background 0.2s;
        }
        .btn:hover { background: #5ed9c0; }
        
        .endpoint { 
            margin: 10px 0; 
            padding: 15px; 
            background: #1e1e1e; 
            border-left: 3px solid #4ec9b0;
            border-radius: 4px;
        }
        .method { 
            color: #4ec9b0; 
            font-weight: bold; 
            display: inline-block;
            width: 80px;
            background: #252526;
            padding: 4px 8px;
            border-radius: 3px;
            text-align: center;
        }
        .path { color: #ce9178; font-family: monospace; }
        
        code { 
            background: #1e1e1e; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-family: 'Courier New', monospace;
            color: #ce9178;
        }
        
        .workflow {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        .workflow-step {
            flex: 1;
            min-width: 200px;
            background: #1e1e1e;
            padding: 20px;
            border-radius: 6px;
            border-top: 3px solid #4ec9b0;
        }
        .workflow-step-number {
            background: #4ec9b0;
            color: #1e1e1e;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        ul { margin-left: 20px; margin-top: 10px; }
        li { margin: 8px 0; }
        
        .stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .stat {
            flex: 1;
            min-width: 150px;
            text-align: center;
            padding: 15px;
            background: #1e1e1e;
            border-radius: 6px;
        }
        .stat-value {
            font-size: 2em;
            color: #4ec9b0;
            font-weight: bold;
        }
        .stat-label {
            color: #858585;
            font-size: 0.9em;
        }
        
        a { color: #4ec9b0; text-decoration: none; }
        a:hover { text-decoration: underline; }
        
        /* Upload Form */
        .upload-section {
            background: #1e1e1e;
            border: 2px dashed #4ec9b0;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
        }
        .upload-area {
            cursor: pointer;
            padding: 40px;
            border: 2px dashed #3e3e3e;
            border-radius: 6px;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #4ec9b0;
            background: #252526;
        }
        .upload-area.dragover {
            border-color: #4ec9b0;
            background: #1f2a2a;
        }
        input[type="file"] {
            display: none;
        }
        .btn-secondary {
            background: #569cd6;
            color: #1e1e1e;
        }
        .btn-secondary:hover {
            background: #6aadd6;
        }
        .btn-danger {
            background: #f48771;
            color: #1e1e1e;
        }
        .btn-danger:hover {
            background: #f59a88;
        }
        
        /* Session Status */
        .session-card {
            background: #1e1e1e;
            border: 1px solid #3e3e3e;
            border-radius: 6px;
            padding: 20px;
            margin: 15px 0;
        }
        .session-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .status-queued { background: #569cd6; color: #1e1e1e; }
        .status-processing { background: #4ec9b0; color: #1e1e1e; }
        .status-ready { background: #4ec9b0; color: #1e1e1e; }
        .status-building_iso { background: #569cd6; color: #1e1e1e; }
        .status-iso_ready { background: #4ec9b0; color: #1e1e1e; }
        .status-error { background: #f48771; color: #1e1e1e; }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #252526;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #4ec9b0;
            transition: width 0.3s;
            text-align: center;
            line-height: 20px;
            font-size: 0.8em;
            color: #1e1e1e;
        }
        
        .hidden { display: none; }
        .error-message {
            background: #2a1f1f;
            border-left: 4px solid #f48771;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
    </style>
{{end}}
    <div class="container">
        <header>
            <h1>{{.T "header.title"}}</h1>
            <p class="subtitle">{{.T "header.subtitle"}}</p>
        </header>
        
        <div class="section">
            <h2>{{.T "sections.what_is_nixos"}}</h2>
            <div class="info-box success">
                <h3>{{.T "nixos.declarative.title"}}</h3>
                <p>{{.T "nixos.declarative.text"}}</p>
            </div>
            
            <div class="info-box success">
                <h3>{{.T "nixos.immutable.title"}}</h3>
                <p>{{.T "nixos.immutable.text"}}</p>
            </div>
            
            <div class="info-box success">
                <h3>{{.T "nixos.atomic.title"}}</h3>
                <p>{{.T "nixos.atomic.text"}}</p>
            </div>
        </div>
        
        <div class="section">
            <h2>{{.T "sections.what_does_nixify"}}</h2>
            <p>{{.T "nixify.description"}}</p>
            <ul>
                <li><strong>{{.T "nixify.features.programs"}}</strong></li>
                <li><strong>{{.T "nixify.features.settings"}}</strong></li>
                <li><strong>{{.T "nixify.features.hardware"}}</strong></li>
                <li><strong>{{.T "nixify.features.config"}}</strong></li>
                <li><strong>{{.T "nixify.features.iso"}}</strong></li>
            </ul>
        </div>
        
        <div class="section">
            <h2>{{.T "sections.how_it_works"}}</h2>
            <div class="workflow">
                <div class="workflow-step">
                    <div class="workflow-step-number">{{.T "workflow.step1.number"}}</div>
                    <h3>{{.T "workflow.step1.title"}}</h3>
                    <p>{{.T "workflow.step1.text"}}</p>
                </div>
                <div class="workflow-step">
                    <div class="workflow-step-number">{{.T "workflow.step2.number"}}</div>
                    <h3>{{.T "workflow.step2.title"}}</h3>
                    <p>{{.T "workflow.step2.text"}}</p>
                </div>
                <div class="workflow-step">
                    <div class="workflow-step-number">{{.T "workflow.step3.number"}}</div>
                    <h3>{{.T "workflow.step3.title"}}</h3>
                    <p>{{.T "workflow.step3.text"}}</p>
                </div>
                <div class="workflow-step">
                    <div class="workflow-step-number">{{.T "workflow.step4.number"}}</div>
                    <h3>{{.T "workflow.step4.title"}}</h3>
                    <p>{{.T "workflow.step4.text"}}</p>
                </div>
                <div class="workflow-step">
                    <div class="workflow-step-number">{{.T "workflow.step5.number"}}</div>
                    <h3>{{.T "workflow.step5.title"}}</h3>
                    <p>{{.T "workflow.step5.text"}}</p>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>{{.T "sections.download_scripts"}}</h2>
            <p>{{.T "download.instructions"}}</p>
            <div class="download-grid">
                <div class="download-card">
                    <h3>{{.T "download.windows.title"}}</h3>
                    <p>{{.T "download.windows.description"}}</p>
                    <a href="/download/windows" class="btn">{{.T "download.button"}}</a>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #858585;">
                        <code>{{.T "download.windows.filename"}}</code>
                    </p>
                </div>
                <div class="download-card">
                    <h3>{{.T "download.macos.title"}}</h3>
                    <p>{{.T "download.macos.description"}}</p>
                    <a href="/download/macos" class="btn">{{.T "download.button"}}</a>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #858585;">
                        <code>{{.T "download.macos.filename"}}</code>
                    </p>
                </div>
                <div class="download-card">
                    <h3>{{.T "download.linux.title"}}</h3>
                    <p>{{.T "download.linux.description"}}</p>
                    <a href="/download/linux" class="btn">{{.T "download.button"}}</a>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #858585;">
                        <code>{{.T "download.linux.filename"}}</code>
                    </p>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>{{.T "sections.upload_report"}}</h2>
            <p>{{.T "upload.description"}}</p>
            
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept=".json,application/json">
                    <p style="font-size: 1.2em; margin-bottom: 10px;">{{.T "upload.drop_zone"}}</p>
                    <p style="color: #858585; font-size: 0.9em;">{{.T "upload.supported"}}</p>
                </div>
                <div id="uploadError" class="error-message hidden"></div>
            </div>
            
            <div id="sessionStatus" class="hidden">
                <div class="session-card">
                    <h3>{{.T "session.status_title"}}</h3>
                    <p><strong>{{.T "session.id"}}:</strong> <code id="sessionId"></code></p>
                    <p><strong>{{.T "session.status"}}:</strong> <span class="session-status" id="sessionStatusBadge">queued</span></p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
                    </div>
                    <div id="sessionActions" class="hidden" style="margin-top: 15px;">
                        <button class="btn" onclick="downloadConfig()">{{.T "session.download_config"}}</button>
                        <button class="btn btn-secondary" onclick="buildISO()" style="margin-left: 10px;">{{.T "session.build_iso"}}</button>
                        <button class="btn btn-danger hidden" onclick="downloadISO()" id="downloadISOBtn" style="margin-left: 10px;">{{.T "session.download_iso"}}</button>
                    </div>
                    <div id="sessionError" class="error-message hidden"></div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>{{.T "sections.important_notes"}}</h2>
            
            <div class="info-box warning">
                <h3>{{.T "warnings.kernel_anticheat.title"}}</h3>
                <p><strong>{{.T "warnings.kernel_anticheat.text"}}</strong></p>
                <p style="margin-top: 10px;">{{.T "warnings.kernel_anticheat.details"}}</p>
            </div>
            
            <div class="info-box info">
                <h3>{{.T "warnings.wine_proton.title"}}</h3>
                <p>{{.T "warnings.wine_proton.text"}}</p>
                <ul style="margin-top: 10px;">
                    {{range .TArray "warnings.wine_proton.features"}}
                    <li>{{.}}</li>
                    {{end}}
                </ul>
            </div>
            
            <div class="info-box success">
                <h3>{{.T "warnings.what_works.title"}}</h3>
                <ul>
                    {{range .TArray "warnings.what_works.items"}}
                    <li>{{.}}</li>
                    {{end}}
                </ul>
            </div>
            
            <div class="info-box info">
                <h3>{{.T "warnings.about_config.title"}}</h3>
                <p>{{.T "warnings.about_config.text"}}</p>
                <ul style="margin-top: 10px;">
                    {{range .TArray "warnings.about_config.features"}}
                    <li>{{.}}</li>
                    {{end}}
                </ul>
            </div>
        </div>
        
        <div class="section">
            <h2>{{.T "sections.service_status"}}</h2>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value">{{.Sessions}}</div>
                    <div class="stat-label">{{.T "status.active_sessions"}}</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="font-size: 1.2em;">{{.Host}}:{{.Port}}</div>
                    <div class="stat-label">{{.T "status.service_address"}}</div>
                </div>
                <div class="stat">
                    <div class="stat-value">{{.T "status.online"}}</div>
                    <div class="stat-label">{{.T "status.service_status"}}</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>{{.T "api.title"}}</h2>
            <p>{{.T "api.description"}}</p>
            
            <div class="endpoint">
                <span class="method">GET</span> <span class="path">/api/v1/health</span>
                <p>{{.T "api.endpoints.health"}}</p>
            </div>
            
            <div class="endpoint">
                <span class="method">POST</span> <span class="path">/api/v1/upload</span>
                <p>{{.T "api.endpoints.upload"}}</p>
            </div>
            
            <div class="endpoint">
                <span class="method">GET</span> <span class="path">/api/v1/sessions</span>
                <p>{{.T "api.endpoints.sessions"}}</p>
            </div>
            
            <div class="endpoint">
                <span class="method">GET</span> <span class="path">/api/v1/session/{id}</span>
                <p>{{.T "api.endpoints.session"}}</p>
            </div>
            
            <div class="endpoint">
                <span class="method">GET</span> <span class="path">/api/v1/config/{id}</span>
                <p>{{.T "api.endpoints.config"}}</p>
            </div>
            
            <div class="endpoint">
                <span class="method">POST</span> <span class="path">/api/v1/iso/build</span>
                <p>{{.T "api.endpoints.iso_build"}}</p>
            </div>
            
            <div class="endpoint">
                <span class="method">GET</span> <span class="path">/api/v1/iso/{id}/download</span>
                <p>{{.T "api.endpoints.iso_download"}}</p>
            </div>
        </div>
        
        <div class="section" style="text-align: center; color: #858585; font-size: 0.9em;">
            <p>{{.T "footer.project"}} <a href="https://github.com/fr4iser90/NixOSControlCenter">NixOS Control Center</a></p>
            <p style="margin-top: 10px;">{{.T "footer.tagline"}}</p>
        </div>
    </div>
    
    <script nonce="{{.Nonce}}">
        let currentSessionId = null;
        let statusCheckInterval = null;
        
        // Upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadError = document.getElementById('uploadError');
        const sessionStatus = document.getElementById('sessionStatus');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        function handleFile(file) {
            if (!file.name.endsWith('.json')) {
                showError('Nur JSON-Dateien werden unterst√ºtzt!');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showError('Datei zu gro√ü! Maximum: 10MB');
                return;
            }
            
            uploadError.classList.add('hidden');
            uploadArea.innerHTML = '<p>üì§ Lade hoch...</p>';
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    uploadReport(json);
                } catch (err) {
                    showError('Ung√ºltige JSON-Datei: ' + err.message);
                    resetUploadArea();
                }
            };
            reader.readAsText(file);
        }
        
        function uploadReport(report) {
            fetch('/api/v1/upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(report)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Upload fehlgeschlagen');
                    });
                }
                return response.json();
            })
            .then(data => {
                currentSessionId = data.session_id;
                // Redirect to review page after upload
                if (data.review_url) {
                    window.location.href = data.review_url;
                } else {
                    // Fallback: redirect to review page manually
                    window.location.href = `/review/${data.session_id}`;
                }
            })
            .catch(error => {
                showError('Upload fehlgeschlagen: ' + error.message);
                resetUploadArea();
            });
        }
        
        function resetUploadArea() {
            uploadArea.innerHTML = `
                <input type="file" id="fileInput" accept=".json,application/json">
                <p style="font-size: 1.2em; margin-bottom: 10px;">üìÅ Datei hier ablegen oder klicken zum Ausw√§hlen</p>
                <p style="color: #858585; font-size: 0.9em;">Unterst√ºtzt: JSON-Dateien (max. 10MB)</p>
            `;
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }
        
        function showError(message) {
            uploadError.textContent = message;
            uploadError.classList.remove('hidden');
        }
        
        function startStatusPolling() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            statusCheckInterval = setInterval(updateSessionStatus, 3000); // Check every 3 seconds
        }
        
        function updateSessionStatus() {
            if (!currentSessionId) return;
            
            fetch(`/api/v1/session/${currentSessionId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Session nicht gefunden');
                    return response.json();
                })
                .then(session => {
                    const statusBadge = document.getElementById('sessionStatusBadge');
                    const progressBar = document.getElementById('progressBar');
                    const sessionActions = document.getElementById('sessionActions');
                    const sessionError = document.getElementById('sessionError');
                    const downloadISOBtn = document.getElementById('downloadISOBtn');
                    
                    statusBadge.textContent = session.status;
                    statusBadge.className = 'session-status status-' + session.status;
                    
                    // Update progress
                    let progress = 0;
                    if (session.status === 'queued') progress = 10;
                    else if (session.status === 'processing') progress = 50;
                    else if (session.status === 'ready') progress = 100;
                    else if (session.status === 'building_iso') progress = 75;
                    else if (session.status === 'iso_ready') progress = 100;
                    else if (session.status === 'error') progress = 0;
                    
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                    
                    // Show actions when ready
                    if (session.status === 'ready' || session.status === 'iso_ready') {
                        sessionActions.classList.remove('hidden');
                        if (session.status === 'iso_ready') {
                            downloadISOBtn.classList.remove('hidden');
                        } else {
                            downloadISOBtn.classList.add('hidden');
                        }
                    } else {
                        sessionActions.classList.add('hidden');
                    }
                    
                    // Show error if any
                    if (session.status === 'error' && session.error) {
                        sessionError.textContent = 'Fehler: ' + session.error;
                        sessionError.classList.remove('hidden');
                    } else {
                        sessionError.classList.add('hidden');
                    }
                    
                    // Stop polling if done or error
                    if (session.status === 'ready' || session.status === 'iso_ready' || session.status === 'error') {
                        clearInterval(statusCheckInterval);
                    }
                })
                .catch(error => {
                    console.error('Status check failed:', error);
                });
        }
        
        function downloadConfig() {
            if (!currentSessionId) return;
            window.location.href = `/api/v1/config/${currentSessionId}`;
        }
        
        function buildISO() {
            if (!currentSessionId) return;
            
            fetch('/api/v1/iso/build', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: currentSessionId
                    // variant wird aus dem generierten desktop-config.nix gelesen, nicht als Parameter!
                })
            })
            .then(response => {
                if (!response.ok) throw new Error('ISO-Build fehlgeschlagen');
                return response.json();
            })
            .then(data => {
                startStatusPolling(); // Resume polling for ISO build status
            })
            .catch(error => {
                alert('Fehler beim ISO-Build: ' + error.message);
            });
        }
        
        function downloadISO() {
            if (!currentSessionId) return;
            window.location.href = `/api/v1/iso/${currentSessionId}/download`;
        }
    </script>
{{end}}
