{{define "mappings"}}
<div class="container">
    <header>
        <h1>{{.T "mappings.title"}}</h1>
        <p class="subtitle">{{.T "mappings.subtitle"}}</p>
    </header>

    <div class="section">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="{{.T "mappings.search"}}" class="search-input-full">
        </div>
        
        <div id="programsList">
            <!-- Programs will be loaded here via JavaScript -->
        </div>
        
        <div id="noResults" class="no-results">
            {{.T "mappings.no_results"}}
        </div>
    </div>
</div>

<script nonce="{{.Nonce}}">
    const programs = {{.ProgramsJSON}};
    const translations = {
        supported: "{{.T "mappings.status.supported"}}",
        partial: "{{.T "mappings.status.partial"}}",
        not_supported: "{{.T "mappings.status.not_supported"}}",
        unknown: "{{.T "mappings.status.unknown"}}",
        category: "{{.T "mappings.category"}}",
        total: "{{.T "mappings.total"}}"
    };
    
    function renderPrograms(filteredPrograms) {
        const container = document.getElementById('programsList');
        const noResults = document.getElementById('noResults');
        
        if (filteredPrograms.length === 0) {
            container.innerHTML = '';
            noResults.style.display = 'block';
            return;
        }
        
        noResults.style.display = 'none';
        container.innerHTML = filteredPrograms.map(prog => {
            const name = prog.name || 'Unknown';
            const category = prog.category || 'uncategorized';
            const hasPackage = prog.nixos_package != null;
            const hasModule = prog.module != null;
            
            let status = 'unknown';
            let statusClass = 'status-not-supported';
            let statusText = translations.unknown;
            
            if (hasPackage && hasModule) {
                status = 'supported';
                statusClass = 'status-supported';
                statusText = translations.supported;
            } else if (hasPackage || hasModule) {
                status = 'partial';
                statusClass = 'status-partial';
                statusText = translations.partial;
            } else {
                status = 'not_supported';
                statusClass = 'status-not-supported';
                statusText = translations.not_supported;
            }
            
            return `
                <div class="program-card">
                    <div class="program-info">
                        <div class="program-name">${escapeHtml(name)}</div>
                        <div class="program-category">${translations.category}: ${escapeHtml(category)}</div>
                        ${prog.nixos_package ? `<div class="program-meta">Package: <code>${escapeHtml(prog.nixos_package)}</code></div>` : ''}
                        ${prog.module ? `<div class="program-meta">Module: <code>${escapeHtml(prog.module)}</code></div>` : ''}
                    </div>
                    <div class="program-status ${statusClass}">${statusText}</div>
                </div>
            `;
        }).join('');
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const filtered = programs.filter(prog => {
            const name = (prog.name || '').toLowerCase();
            const category = (prog.category || '').toLowerCase();
            const package = (prog.nixos_package || '').toLowerCase();
            return name.includes(query) || category.includes(query) || package.includes(query);
        });
        renderPrograms(filtered);
    });
    
    // Initial render
    renderPrograms(programs);
    
    // Show stats
    const stats = document.createElement('div');
    stats.className = 'stats';
    stats.textContent = `${translations.total}: ${programs.length}`;
    document.getElementById('programsList').parentNode.appendChild(stats);
</script>
{{end}}
