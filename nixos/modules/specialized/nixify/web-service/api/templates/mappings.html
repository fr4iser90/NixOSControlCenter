{{define "mappings"}}
<div class="container">
    <header>
        <h1>{{.T "mappings.title"}}</h1>
        <p class="subtitle">{{.T "mappings.subtitle"}}</p>
    </header>

    <div class="section">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="{{.T "mappings.search"}}" class="search-input-full">
        </div>
        
        <div id="programsList">
            <!-- Programs will be loaded here via JavaScript -->
        </div>
        
        <div id="noResults" class="no-results">
            {{.T "mappings.no_results"}}
        </div>
    </div>
</div>

<script nonce="{{.Nonce}}">
    const programs = {{.ProgramsJSON}};
    const translations = {
        supported: "{{.T "mappings.status.supported"}}",
        alternative: "{{.T "mappings.status.alternative"}}",
        wine: "{{.T "mappings.status.wine"}}",
        proton: "{{.T "mappings.status.proton"}}",
        flatpak: "{{.T "mappings.status.flatpak"}}",
        appimage: "{{.T "mappings.status.appimage"}}",
        module_only: "{{.T "mappings.status.module_only"}}",
        not_supported: "{{.T "mappings.status.not_supported"}}",
        unknown: "{{.T "mappings.status.unknown"}}",
        category: "{{.T "mappings.category"}}",
        alternatives: "{{.T "mappings.alternatives"}}",
        total: "{{.T "mappings.total"}}"
    };
    
    function renderPrograms(filteredPrograms) {
        const container = document.getElementById('programsList');
        const noResults = document.getElementById('noResults');
        
        if (filteredPrograms.length === 0) {
            container.innerHTML = '';
            noResults.style.display = 'block';
            return;
        }
        
        noResults.style.display = 'none';
        container.innerHTML = filteredPrograms.map(prog => {
            const name = prog.name || 'Unknown';
            const category = prog.category || 'uncategorized';
            const hasPackage = prog.nixos_package != null;
            const hasModule = prog.module != null;
            const hasWine = prog.wine === true;
            const hasProton = prog.proton === true;
            const hasFlatpak = prog.flatpak != null;
            const hasAppImage = prog.appimage === true;
            const isAlternative = prog.nixos_package != null && prog.note && prog.note.toLowerCase().includes('alternative');
            
            let status = 'unknown';
            let statusClass = 'status-not-supported';
            let statusText = translations.unknown;
            let statusIcon = '';
            
            // Verf√ºgbar = hat Package (egal ob Modul oder nicht)
            if (hasPackage) {
                if (isAlternative) {
                    status = 'alternative';
                    statusClass = 'status-alternative';
                    statusText = translations.alternative;
                    statusIcon = 'üîÑ';
                } else {
                    status = 'supported';
                    statusClass = 'status-supported';
                    statusText = translations.supported;
                    statusIcon = '‚úÖ';
                }
            }
            // Via Wine
            else if (hasWine) {
                status = 'wine';
                statusClass = 'status-wine';
                statusText = translations.wine;
                statusIcon = 'üç∑';
            }
            // Via Proton
            else if (hasProton) {
                status = 'proton';
                statusClass = 'status-proton';
                statusText = translations.proton;
                statusIcon = 'üéÆ';
            }
            // Via Flatpak
            else if (hasFlatpak) {
                status = 'flatpak';
                statusClass = 'status-flatpak';
                statusText = translations.flatpak;
                statusIcon = 'üì¶';
            }
            // Via AppImage
            else if (hasAppImage) {
                status = 'appimage';
                statusClass = 'status-appimage';
                statusText = translations.appimage;
                statusIcon = 'üì¶';
            }
            // Nur Modul (kein Package)
            else if (hasModule) {
                status = 'module_only';
                statusClass = 'status-module';
                statusText = translations.module_only;
                statusIcon = 'üîß';
            }
            // Nicht verf√ºgbar
            else {
                status = 'not_supported';
                statusClass = 'status-not-supported';
                statusText = translations.not_supported;
                statusIcon = '‚ùå';
            }
            
            return `
                <div class="program-card">
                    <div class="program-info">
                        <div class="program-name">${escapeHtml(name)}</div>
                        <div class="program-category">${translations.category}: ${escapeHtml(category)}</div>
                        ${prog.nixos_package ? `<div class="program-meta">Package: <code>${escapeHtml(prog.nixos_package)}</code></div>` : ''}
                        ${prog.module ? `<div class="program-meta">Module: <code>${escapeHtml(prog.module)}</code></div>` : ''}
                        ${prog.wine ? `<div class="program-meta">üç∑ Runs via Wine</div>` : ''}
                        ${prog.proton ? `<div class="program-meta">üéÆ Runs via Proton (Steam)</div>` : ''}
                        ${prog.flatpak ? `<div class="program-meta">üì¶ Flatpak: <code>${escapeHtml(prog.flatpak)}</code></div>` : ''}
                        ${prog.appimage ? `<div class="program-meta">üì¶ AppImage available</div>` : ''}
                        ${prog.note ? `<div class="program-note">${escapeHtml(prog.note)}</div>` : ''}
                        ${prog.alternatives && prog.alternatives.length > 0 ? `
                            <div class="program-alternatives">
                                <strong>${translations.alternatives || 'Alternatives'}:</strong>
                                ${prog.alternatives.map(alt => `
                                    <div class="alternative-item">
                                        <span class="alternative-name">${escapeHtml(alt.name)}</span>
                                        ${alt.package ? `<code class="alternative-package">${escapeHtml(alt.package)}</code>` : ''}
                                        ${alt.reason ? `<span class="alternative-reason">${escapeHtml(alt.reason)}</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="program-status ${statusClass}">${statusIcon} ${statusText}</div>
                </div>
            `;
        }).join('');
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const filtered = programs.filter(prog => {
            const name = (prog.name || '').toLowerCase();
            const category = (prog.category || '').toLowerCase();
            const package = (prog.nixos_package || '').toLowerCase();
            return name.includes(query) || category.includes(query) || package.includes(query);
        });
        renderPrograms(filtered);
    });
    
    // Initial render
    renderPrograms(programs);
    
    // Show stats
    const stats = document.createElement('div');
    stats.className = 'stats';
    stats.textContent = `${translations.total}: ${programs.length}`;
    document.getElementById('programsList').parentNode.appendChild(stats);
</script>
{{end}}
